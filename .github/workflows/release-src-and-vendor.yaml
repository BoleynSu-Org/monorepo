name: Release source code and vendored dependencies

on:
  create:
    tags:
      - "v*"

jobs:
  release-src-and-vendor:
    runs-on: ubuntu-latest
    steps:
      - name: Install bazel
        run: |
          mkdir $HOME/bin
          curl -L https://github.com/bazelbuild/bazel/releases/download/8.1.1/bazel-8.1.1-installer-linux-x86_64.sh >$HOME/bin/bazel
          chmod +x $HOME/bin/bazel

      - name: Set sysctl to allow unshare
        run: |
          # See https://github.com/actions/runner-images/issues/10443#issuecomment-2296608244
          sudo sysctl -w kernel.unprivileged_userns_clone=1
          # See https://github.com/lima-vm/lima/issues/2319#issuecomment-2094746425
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bazel vendor
        run: |
          bazel vendor --config=vendor --config=ci-build-and-test //...
          bazel vendor --config=vendor --config=ci-deploy //...

      - name: Clean bazel cache
        run: |
          bazel clean --expunge

      - name: Run bazel build without network
        run: |
          bazel shutdown
          unshare -c -n bash -c "
            bazel build --config=vendor --config=ci-build-and-test --remote_executor= --bes_results_url= --bes_backend= //...
            bazel build --config=vendor --config=ci-deploy --remote_executor= --bes_results_url= --bes_backend= //...
          "

      - name: Release
        uses: softprops/action-gh-release@v2

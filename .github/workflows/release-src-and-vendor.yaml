name: Release source code and vendored dependencies

on:
  create:
    tags:
      - "v*"

jobs:
  release-src-and-vendor:
    runs-on: ubuntu-latest
    steps:
      - name: Set sysctl to allow unshare
        run: |
          # See https://github.com/actions/runner-images/issues/10443#issuecomment-2296608244
          sudo sysctl -w kernel.unprivileged_userns_clone=1
          # See https://github.com/lima-vm/lima/issues/2319#issuecomment-2094746425
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bazel vendor
        run: |
          alias bazel=bazelisk
          bazel vendor --config=vendor --config=ci-build-and-test //...
          bazel vendor --config=vendor --config=ci-deploy //...

      - name: Clean bazel cache
        run: |
          alias bazel=bazelisk
          bazel clean --expunge

      - name: Run bazel test without network
        run: |
          id=$(id -u)
          unshare -r -n bash -c "
            ip link set dev lo up
            unshare --map-user $id bash -c '
              alias bazel=bazelisk
              bazel test --config=vendor --config=ci-build-and-test --remote_executor= --bes_results_url= --bes_backend= //...
              bazel test --config=vendor --config=ci-deploy --remote_executor= --bes_results_url= --bes_backend= //...
            '
          "

      - name: Package source code and vendored dependencies
        run: |
          git archive --format=zip --output=src-and-vendor.zip HEAD .
          chmod +r -R vendor/
          zip -yuqr src-and-vendor.zip vendor/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: src-and-vendor.zip
